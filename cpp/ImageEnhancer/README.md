# ImageEnhancer
Проект основан на использовании Qt и OpenCV. Предназначен для улучшения качества изображения с использованием onnx моделей, полученных из HINet.
## Ограничения решения
Данное решение работает целиком с изображением. Вариант разбиения изображения на блоки по 256x256 и объединения их в один батч не реализован в виду ограничения времени.

Кроме того, если самая длинная сторона входного изображения будет превышать 1280, то изображение будет отскалировано к 1280x720 или 720x1280 **без сохренения соотношения сторон!**
## Среда сборки и тестирования
### Окружение
* Ubuntu 22.04
* Qt 5.15.3
* gcc 11.3.0
* opencv 4.5.4
* CMake 3.26.4
### Тестовое оборудование
* CPU: Intel i9-12900H
* RAM: 16 Gb
* GPU: none  
**ВНИМАНИЕ!** Количество оперативной памяти важно, поскольку 16 Gb едва хватает на запуск модели для изображения 1280x720. Возможно ограничить потребляемую память за счёт разбиения изображений на блоки размером 256x256 и запуском их иференса поочереди.
## Опсиание содержимого
* *src/* - исходный код
* *CMakeLists.txt* - главный CMakeLists
* *src/backend/* - исходный код backend, содержащий классы для работы с изображениями, тензорами и инференсом модели
* *src/ImageEnhancer.{cpp|h}* - класс, реализующий логику взаимодействия UI и backend
* *MainWindow.{cpp|h}* - главное окно GUI
* *main_console.cpp* - main консольного приложения
* *main_gui.cpp* - main приложения с графическим интерфейсом
## Настройка окружения для Ubuntu 22.04
1. Установка Qt
```
sudo apt install qtbase5-dev qtwayland5
```
2. Установка OpenCV
```
sudo apt install libopencv-dev
```
3. Установка CMake
```
sudo apt install cmake
```
**ВНИМАНИЕ!** Данная команда установить CMake==3.22.1, сборка произоводилась с версией 3.26.4, однако в CMakeLists указана минимальная версия 3.15. Поэтому нет необходимости скачивать deb пакет с сайта CMake.
## Сборка
Подразумевается, что все команды выполняются из директории *cpp/ImageEnhancer*
1. Создать директорию build и перейти в неё
```
mkdir build && cd build
```
2. Сконфигурировать проект
```
cmake ../ -DCMAKE_BUILD_TYPE=Release
```
3. Собрать проект
```
cmake --build . -j8
```
4. Скопировать onnx модель, полученную на этапе работы с *python/* решением в директорию с артефактами сборки
## Использование *console_enhancer*
Приложение обрабатывает одно изображение, сохраняет результат и завершает работу.   
Консольное приложение имеет следующие входные параметры
```
Options:
  -h, --help                               Displays help on commandline
                                           options.
  --help-all                               Displays help including Qt specific
                                           options.
  --onnx_model_path <onnx_model_path>      Path to the onnx model
  --input_image_path <input_image_path>    Input image path
  --output_image_path <output_image_path>  Output image path
```
Пример запуска
```
--onnx_model_path HINet-GoPro.onnx --input_image_path GOPR0384_11_00-000001.png --output_image_path res.png
```
## Использование *gui_enhancer*
Приложение позволяет выбрать файл на ПК, посмотреть его и обработать. **Результат обработки не сохраняется!**  
Приложение не принимает входные параметры, путь до используемой onnx модели захардкожен, поэтому необходимо, чтобы можель была рядом с бинарным файлом.
Пример запуска
```
./gui_enhancer
```
## Возможные улучшения
1. Выделить отдельный каталог GUI и разделить MainWindow на более обособленные составляющие.
2. Явным образом выделить интерфейсную часть backend и обернуть необходимые классы используя паттерн PImpl, чтобы скрыть зависимость от OpenCV.
3. Выделить класс конфигуратор (или фабрику), который будет ответственен за создание объектов HIMProcessor, переместив таким образом логику его создания из main_console.cpp и main_gui.cpp.
4. Расширить функционал созданных классов (или создать новые) для пред/постобработки изображений/тензоров, добавив формирование батча из блоков, на которые делится изображение, как это сделано в исходном репозитории.
5. Объединить пайплайн конвертации onnx модели со сборкой C++ решения и настроить общий CI/CD.
6. Расширить GUI функционал: добавить возможность выбора модели, платформы для запуска (CPU, GPU); добавить возмлжность сохранение результата; шкалу прогресса обработки и др. 